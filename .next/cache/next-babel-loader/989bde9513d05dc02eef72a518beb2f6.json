{"ast":null,"code":"var __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport React, { Component } from 'react';\nimport { withRouter } from 'next/router';\nimport dynamic from 'next/dynamic';\nimport Layout from '../../components/layout';\nimport { Button, Accordion, List, Icon } from 'semantic-ui-react';\nimport { AuthRequired } from '../../components/authProvider';\nimport Queue from '../../components/queue/queue';\nimport * as api from '../../util/mercuryService';\nimport CreateGroupModal from '../../components/createGroupModal';\nimport UserInviteModal from '../../components/invite/userInviteModal';\nimport { EventEmitter } from '../../components/util/EventEmitter';\nimport FeedbackModal from '../../components/feedbackModal';\nimport StudentWebSocketClient from '../../util/studentWebSocket';\nimport TAWebSocketClient from '../../util/taWebSocket';\nimport ReceiveInviteModal from '../../components/invite/receiveInviteModal';\nimport { NotificationContainer, NotificationManager } from 'react-notifications';\nimport GroupJoinRequestModal from '../../components/invite/groupJoinRequestModal';\nimport WaitingForRequestApprovalModal from '../../components/invite/WaitingForRequestApprovalModal';\nconst ScreenContainer = dynamic(() => import('../../components/screenContainer'), {\n  ssr: false,\n  loadableGenerated: {\n    webpack: () => [require.resolveWeak('../../components/screenContainer')],\n    modules: ['../../components/screenContainer']\n  }\n});\nconst CreateDiscussionModal = dynamic(() => import('../../components/createDiscussionModal'), {\n  ssr: false,\n  loadableGenerated: {\n    webpack: () => [require.resolveWeak('../../components/createDiscussionModal')],\n    modules: ['../../components/createDiscussionModal']\n  }\n});\n\nclass ClassPage extends Component {\n  constructor(props) {\n    super(props);\n\n    _defineProperty(this, \"leaveGroupForTAOffice\", () => {\n      EventEmitter.publish('userLeaveGroup', this.state.currentGroup);\n      this.setState({\n        vonageCred: null,\n        currentGroup: {\n          id: '',\n          name: ''\n        },\n        withTa: false\n      });\n      EventEmitter.publish('currentGroupChange', {\n        id: '',\n        name: ''\n      });\n    });\n\n    _defineProperty(this, \"leaveGroup\", () => {\n      EventEmitter.publish('userLeaveGroup', this.state.currentGroup);\n      this.setState({\n        vonageCred: null,\n        currentGroup: {\n          id: '',\n          name: ''\n        },\n        withTa: false\n      });\n      EventEmitter.publish('currentGroupChange', {\n        id: '',\n        name: ''\n      });\n      EventEmitter.publish('callOver', this.classId);\n    });\n\n    _defineProperty(this, \"fetchCurrentClass\", () => {\n      api.getClass(this.classId).then(c => {\n        const userRole = c.users.find(u => u.id === this.user.id);\n        if (!userRole) this.props.router.push('/calendar');\n        this.setState({\n          currentClass: _objectSpread(_objectSpread({}, c), {}, {\n            role: userRole.role\n          })\n        });\n      }).catch(console.error);\n    });\n\n    _defineProperty(this, \"handleBack\", async () => {\n      await this.props.router.push('/calendar');\n    });\n\n    _defineProperty(this, \"handleSelectGroup\", async group => {\n      const {\n        role\n      } = this.state.currentClass;\n\n      if (group.type === 'office' || role === 'Professor' || group.type === 'discussion') {\n        // you are popped off the waiting queue or you are a TA\n        this.joinGroup(group);\n        return;\n      }\n      /**\n       * First, check if you are the leader of the group\n       */\n\n\n      const currGroup = await api.getGroupByID(this.classId, group.id);\n      const {\n        UserId\n      } = currGroup;\n      const {\n        id\n      } = this.user;\n\n      if (UserId === id) {\n        // you are the leader of the group, no need for authentication\n        this.joinGroup(group);\n      } else {\n        /**\n         * Ping group leader to let you into the group\n         */\n        EventEmitter.publish('activateWaitingForRequestApprovalModal', group);\n        EventEmitter.publish('requestJoinGroup', {\n          userId: id,\n          group: group\n        });\n      }\n    });\n\n    _defineProperty(this, \"handleCreateGroup\", async group => {\n      const groupData = await api.postGroup(this.classId, group.name, group.type, this.user.id);\n      this.fetchCurrentClass();\n      EventEmitter.publish('classGroupSetChanged', this.classId);\n      await this.handleSelectGroup(groupData);\n    });\n\n    this.state = {\n      withTa: false,\n      clicked: 'none',\n      currentGroup: {\n        id: '',\n        name: ''\n      },\n      currentClass: {\n        id: '',\n        name: '',\n        groups: [],\n        users: [],\n        role: 'Student'\n      },\n      vonageCred: null,\n      isMounted: false\n    };\n    this.defineEventEmitterCallbacks();\n  }\n\n  joinGroup(group) {\n    api.postGroupToken(this.classId, group.id).then(({\n      token\n    }) => {\n      if (this.state.currentGroup.id != '') {\n        //the user is currently in a call, leave the call first\n        if (group.type === 'office') {\n          // this case only happens when the user is leaving a private group for the TA office\n          // do not trigger the callOver event in this case\n          this.leaveGroupForTAOffice();\n        } else {\n          this.leaveGroup();\n        }\n      }\n\n      this.setState({\n        vonageCred: {\n          sessionId: group.sessionId,\n          token\n        },\n        currentGroup: group\n      });\n      EventEmitter.publish('userJoinGroup', {\n        groupId: group.id,\n        userId: this.user.id\n      });\n      EventEmitter.publish('currentGroupChange', group);\n    }).catch(console.error);\n  }\n\n  defineEventEmitterCallbacks() {\n    EventEmitter.subscribe('clearLeftSide', () => {\n      this.setState({\n        withTa: true\n      });\n    });\n    EventEmitter.subscribe('joinPrivateGroupOnApproval', group => {\n      EventEmitter.publish('removeWaitingForRequestApprovalModal');\n      this.joinGroup(group);\n    });\n    EventEmitter.subscribe('notifyJoinRequestDeclined', group => {\n      NotificationManager.info(`Your Request To Join ${group.name} Was Declined`);\n      EventEmitter.publish('removeWaitingForRequestApprovalModal');\n    });\n    EventEmitter.subscribe('fetchGroups', () => {\n      this.fetchCurrentClass();\n    });\n    EventEmitter.subscribe('createNotification', msg => {\n      NotificationManager.info(msg);\n    });\n  }\n\n  componentDidMount() {\n    const {\n      classId\n    } = this.props.router.query;\n    if (!classId) return;\n    this.classId = Number(classId);\n    api.getMe().then(meData => {\n      this.user = meData;\n    }).then(() => api.getClass(this.classId)).then(c => {\n      const userRole = c.users.find(u => u.id === this.user.id);\n      if (!userRole) this.props.router.push('/calendar');\n      const {\n        role\n      } = userRole;\n      /**\n       * Start the appropriate web socket handler depending on the user role\n       */\n\n      if (role === 'Student') {\n        /**\n         * Start student web socket handler\n         */\n        new StudentWebSocketClient().start({\n          me: this.user,\n          courseId: this.classId\n        });\n      } else {\n        /**\n         * Start TA web socket handler\n         */\n        new TAWebSocketClient().start({\n          me: this.user,\n          courseId: this.classId,\n          onJoin: this.handleSelectGroup\n        });\n      }\n\n      this.setState({\n        currentClass: _objectSpread(_objectSpread({}, c), {}, {\n          role: userRole.role\n        }),\n        isMounted: true\n      });\n\n      if (role === 'Student') {\n        EventEmitter.publish('allOtherStudentsInClass', this.state.currentClass.users.filter(user => user.id !== this.user.id && user.role === 'Student'));\n      } else {\n        EventEmitter.publish('allOtherTAsInClass', this.state.currentClass.users.filter(user => user.id !== this.user.id && user.role === 'Professor'));\n      }\n\n      EventEmitter.publish('me', this.user);\n    }).catch(console.error);\n  }\n\n  getButtonToDisplay() {\n    return this.state.currentClass.role === 'Student' ? __jsx(CreateGroupModal, {\n      onCreate: this.handleCreateGroup\n    }) : this.state.clicked === 'none' ? __jsx(Button, {\n      color: \"teal\",\n      content: \"Modify Discussions\",\n      fluid: true,\n      style: {\n        fontSize: '1vw'\n      },\n      onClick: () => {\n        this.setState({\n          clicked: 'inline'\n        });\n      }\n    }) : __jsx(React.Fragment, null, __jsx(CreateDiscussionModal, {\n      id: \"createDiscussionModal\",\n      onCreate: this.handleCreateGroup\n    }), __jsx(Button, {\n      color: \"red\",\n      content: \"Done\",\n      fluid: true,\n      style: {\n        fontSize: '1vw',\n        marginTop: '2%'\n      },\n      onClick: () => {\n        this.setState({\n          clicked: 'none'\n        });\n      }\n    }));\n  }\n\n  getDeleteButton(group) {\n    return __jsx(Button, {\n      id: `deletebutton${group.id}`,\n      compact: true,\n      icon: true,\n      size: \"mini\",\n      floated: \"right\",\n      style: {\n        display: `${this.state.clicked}`,\n        fontSize: '.6vw',\n        textAlign: 'center',\n        width: '10%',\n        marginBottom: '2%',\n        minWidth: '10px',\n        backgroundColor: 'transparent'\n      },\n      onClick: () => api.deleteGroup(this.classId, group.id).then(() => {\n        this.fetchCurrentClass();\n        EventEmitter.publish('classGroupSetChanged', this.classId);\n      })\n    }, __jsx(Icon, {\n      name: \"delete\",\n      color: \"red\"\n    }));\n  }\n\n  showInviteButton(group) {\n    const plusIcon = __jsx(List.Icon, {\n      name: \"user plus\",\n      onClick: () => {\n        EventEmitter.publish('openInviteModal', true);\n      }\n    });\n\n    const noPlusIcon = __jsx(\"div\", null);\n\n    return this.state.currentGroup.id == group.id && this.state.vonageCred !== null ? plusIcon : noPlusIcon;\n  }\n\n  getListItemStyle(group) {\n    const unClickedGroupsStyle = {\n      fontSize: '.8vw',\n      textAlign: 'left',\n      width: '80%',\n      marginBottom: '2%',\n      minWidth: '41px',\n      display: 'inline-block'\n    };\n    const clickedGroupsStyle = {\n      fontSize: '.8vw',\n      textAlign: 'left',\n      width: '80%',\n      marginBottom: '2%',\n      minWidth: '41px',\n      background: '#e0e1e2',\n      borderRadius: 10,\n      borderWidth: 1,\n      borderColor: '#fff',\n      display: 'inline-block'\n    };\n    return this.state.currentGroup.id == group.id && this.state.vonageCred !== null ? clickedGroupsStyle : unClickedGroupsStyle;\n  }\n\n  showOffice() {\n    return (this.state.currentClass.role !== 'Student' || this.state.currentGroup.type === 'office') && __jsx(\"div\", {\n      style: {\n        paddingLeft: 20\n      }\n    }, __jsx(List, {\n      relaxed: true,\n      selection: true,\n      verticalAlign: \"middle\"\n    }, this.state.currentClass.groups.filter(group => group.type === 'office').map(group => __jsx(List.Item, {\n      key: `office`,\n      onClick: () => {\n        if (this.state.currentGroup.id !== group.id) {\n          this.handleSelectGroup(group);\n        }\n      },\n      style: this.getListItemStyle(group)\n    }, __jsx(List.Icon, {\n      name: \"graduation cap\"\n    }), __jsx(List.Content, null, __jsx(List.Header, {\n      as: \"a\"\n    }, \"TA Office\")), this.showInviteButton(group)))));\n  }\n\n  leftDisplay() {\n    return this.state.withTa === false ? __jsx(\"div\", {\n      style: {\n        height: '100%',\n        marginLeft: '2.5%'\n      }\n    }, __jsx(Button.Group, {\n      size: \"huge\",\n      style: {\n        marginBottom: 12,\n        width: '100%'\n      },\n      fluid: true\n    }, __jsx(Button, {\n      compact: true,\n      icon: \"angle left\",\n      content: this.state.currentClass.name,\n      style: {\n        fontSize: '1.5vw',\n        textAlign: 'left',\n        width: '75%',\n        marginBottom: '2%',\n        minWidth: '41px'\n      },\n      onClick: this.handleBack\n    })), this.showOffice(), __jsx(Accordion, {\n      fluid: true,\n      exclusive: false,\n      defaultActiveIndex: [0, 1],\n      style: {\n        fontSize: '1vw',\n        textAlign: 'left',\n        width: '100%',\n        marginBottom: '2%',\n        minWidth: '41px'\n      },\n      panels: [{\n        key: 'discussions',\n        title: 'Discussions',\n        content: {\n          content: __jsx(\"div\", {\n            style: {\n              paddingLeft: 20,\n              height: 200,\n              overflow: 'auto'\n            }\n          }, __jsx(List, {\n            relaxed: true,\n            selection: true\n          }, this.state.currentClass.groups.filter(group => group.type === 'discussion').map(group => __jsx(React.Fragment, null, __jsx(List.Item, {\n            key: `discussion_${group.id}`,\n            onClick: () => {\n              if (this.state.currentGroup.id !== group.id) {\n                this.handleSelectGroup(group);\n              }\n            },\n            style: this.getListItemStyle(group)\n          }, __jsx(List.Icon, {\n            name: \"sound\"\n          }), __jsx(List.Content, null, __jsx(List.Header, {\n            as: \"a\"\n          }, group.name)), this.showInviteButton(group)), this.getDeleteButton(group)))))\n        }\n      }, {\n        key: 'private-groups',\n        title: 'Private Groups',\n        content: {\n          content: __jsx(\"div\", {\n            style: {\n              paddingLeft: 20,\n              height: 200,\n              overflow: 'auto'\n            }\n          }, __jsx(List, {\n            relaxed: true,\n            selection: true\n          }, this.state.currentClass.groups.filter(group => group.type === 'group').map(group => __jsx(List.Item, {\n            key: `private_group_${group.id}`,\n            onClick: () => {\n              if (this.state.currentGroup.id !== group.id) {\n                this.handleSelectGroup(group);\n              }\n            },\n            style: this.getListItemStyle(group)\n          }, __jsx(List.Icon, {\n            name: \"lock\"\n          }), __jsx(List.Content, null, __jsx(List.Header, {\n            as: \"a\"\n          }, group.name)), this.showInviteButton(group)))))\n        }\n      }]\n    }), __jsx(\"div\", {\n      style: {\n        position: 'absolute',\n        width: 'calc(100% - 38px)',\n        bottom: 14\n      }\n    }, this.getButtonToDisplay())) : __jsx(\"div\", null, \" \");\n  }\n\n  render() {\n    if (!this.state.isMounted) {\n      return null;\n    }\n\n    return __jsx(Layout, {\n      left: this.leftDisplay(),\n      right: __jsx(Queue, {\n        onJoin: this.handleSelectGroup\n      })\n    }, this.state.vonageCred && __jsx(ScreenContainer, {\n      style: {\n        width: '100%',\n        maxHeight: '75vh'\n      },\n      sessionId: this.state.vonageCred.sessionId,\n      token: this.state.vonageCred.token,\n      onLeave: this.leaveGroup,\n      currGroup: this.state.currentGroup,\n      user: this.user,\n      name: this.user.firstName + \" \" + this.user.lastName\n    }), __jsx(UserInviteModal, null), __jsx(FeedbackModal, null), __jsx(ReceiveInviteModal, {\n      onJoin: this.handleSelectGroup\n    }), __jsx(GroupJoinRequestModal, null), __jsx(WaitingForRequestApprovalModal, null), __jsx(NotificationContainer, null));\n  }\n\n}\n\nexport default AuthRequired(withRouter(ClassPage));","map":null,"metadata":{},"sourceType":"module"}